<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="毕业设计的开发日志，用于实时记录学到的trick。"><title>毕业设计 | 水墨风格化场景渲染（其三）</title><link rel=canonical href=https://Selaphina.github.io/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/><link rel=stylesheet href=/scss/style.min.86591c898bd806857815fbb8c47e8d3fed97c133b78e83d9bfc27b164dd0aa2b.css><meta property='og:title' content="毕业设计 | 水墨风格化场景渲染（其三）"><meta property='og:description' content="毕业设计的开发日志，用于实时记录学到的trick。"><meta property='og:url' content='https://Selaphina.github.io/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/'><meta property='og:site_name' content='Selaphina'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Note'><meta property='article:published_time' content='2025-12-20T10:12:30+00:00'><meta property='article:modified_time' content='2025-12-20T10:12:30+00:00'><meta property='og:image' content='https://Selaphina.github.io/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/cover1.png'><meta name=twitter:title content="毕业设计 | 水墨风格化场景渲染（其三）"><meta name=twitter:description content="毕业设计的开发日志，用于实时记录学到的trick。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://Selaphina.github.io/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/cover1.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_19bb7832d48d68bd.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Selaphina</a></h1><h2 class=site-description>住在一个奇妙而荒诞的星球。</h2></div></header><ol class=menu-social><li><a href=https://github.com/Selaphina target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#1-deepseek-api>1 Deepseek API</a><ol><li><a href=#deepseekdialoguemanager>DeepSeekDialogueManager</a></li></ol></li><li><a href=#2-用户界面>2 用户界面</a></li><li><a href=#3-脚本信息引用>3 脚本信息引用</a></li><li><a href=#4-初步测试对话功能>4 初步测试对话功能</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/cover1_hu_a2507cb5e006e692.png srcset="/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/cover1_hu_a2507cb5e006e692.png 800w, /p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/cover1_hu_8370db17030da67a.png 1600w" width=800 height=490 loading=lazy alt="Featured image of post 毕业设计 | 水墨风格化场景渲染（其三）"></a></div><div class=article-details><header class=article-category><a href=/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/ style=background-color:#beefe1;color:#0f3d30>技术笔记</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/>毕业设计 | 水墨风格化场景渲染（其三）</a></h2><h3 class=article-subtitle>毕业设计的开发日志，用于实时记录学到的trick。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-20T10:12:30Z>Dec 20, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><h1></h1><h1 id=进度报告>进度报告</h1><p>本次主要记录AI对话功能及用户界面的接入。</p><h2 id=1-deepseek-api>1 Deepseek API</h2><p><a class=link href=https://api-docs.deepseek.com/zh-cn/ target=_blank rel=noopener>首次调用 API | DeepSeek API Docs</a></p><p><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220203710726.png width=1322 height=834 srcset="/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220203710726_hu_3ae46bdcc7dddc21.png 480w, /p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220203710726_hu_b2e92757b8633dde.png 1024w" loading=lazy alt=image-20251220203710726 class=gallery-image data-flex-grow=158 data-flex-basis=380px></p><p>根据Deepseek API 文档，将调用对话API写一个C#脚本。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Please install OpenAI SDK first: `pip3 install openai`</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>api_key</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;DEEPSEEK_API_KEY&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>base_url</span><span class=o>=</span><span class=s2>&#34;https://api.deepseek.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;deepseek-chat&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;You are a helpful assistant&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;Hello&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>stream</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>将官方提供的python脚本给ai，让其改成C#版本的就可以。</p></blockquote><h3 id=deepseekdialoguemanager>DeepSeekDialogueManager</h3><p>由于后面要考虑对话的用户界面和动画状态机等等，这里直接贴出最终的LLM调用脚本。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=k>using</span> <span class=nn>UnityEngine</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>UnityEngine.UI</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>TMPro</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Collections</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>UnityEngine.Networking</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.IO</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>DeepSeekDialogueManager</span> <span class=p>:</span> <span class=n>MonoBehaviour</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>string</span> <span class=n>botMessage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// API 配置</span>
</span></span><span class=line><span class=cl><span class=na>    [Header(&#34;API Settings&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=kt>string</span> <span class=n>apiKey</span> <span class=p>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=kt>string</span> <span class=n>apiUrl</span> <span class=p>=</span> <span class=s>&#34;https://api.deepseek.com/v1/chat/completions&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//private const string modelName = &#34;deepseek-reasoner&#34;;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>const</span> <span class=kt>string</span> <span class=n>modelName</span> <span class=p>=</span> <span class=s>&#34;deepseek-chat&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// UI 绑定</span>
</span></span><span class=line><span class=cl><span class=na>    [Header(&#34;UI References&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>public</span> <span class=n>TMP_InputField</span> <span class=n>userInputField</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=n>TextMeshProUGUI</span> <span class=n>chatOutputText</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=n>Button</span> <span class=n>sendButton</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=n>AudioSource</span> <span class=n>audioSource</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [Header(&#34;思考指示器&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>public</span> <span class=n>TextMeshProUGUI</span> <span class=n>thinkingIndicator</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Header(&#34;对话背景&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>public</span> <span class=n>TMP_InputField</span> <span class=n>BGInputField</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=n>Button</span> <span class=n>Button1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Header(&#34;角色名字&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>public</span> <span class=n>TMP_InputField</span> <span class=n>RoleName</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=n>Button</span> <span class=n>Button2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Header(&#34;人格设定&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>public</span> <span class=n>TMP_InputField</span> <span class=n>PersonalityInputField</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=n>Button</span> <span class=n>Button3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [Header(&#34;动画&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>private</span> <span class=n>Animator</span> <span class=n>m_Animator</span><span class=p>;</span> <span class=c1>// 动画控制器</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 对话参数</span>
</span></span><span class=line><span class=cl><span class=na>    [Header(&#34;对话设置&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>    [Range(0, 2)]</span> <span class=kd>public</span> <span class=kt>float</span> <span class=n>temperature</span> <span class=p>=</span> <span class=m>0.7f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [Range(1, 1000)]</span> <span class=kd>public</span> <span class=kt>int</span> <span class=n>maxTokens</span> <span class=p>=</span> <span class=m>200</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 角色设定</span>
</span></span><span class=line><span class=cl>    <span class=c1>//[SerializeField] private string RoleName;</span>
</span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>class</span> <span class=nc>NPCCharacter</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>        [TextArea(3, 10)]</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>personalityPrompt</span> <span class=p>=</span> <span class=s>$&#34;你是中国传媒大学的介绍精灵，你掌握一切关于中国传媒大学的历史和现在的知识。联网搜索。&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>//public string personalityPrompt = ;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>    [SerializeField]</span> <span class=kd>public</span> <span class=n>NPCCharacter</span> <span class=n>npcCharacter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 修复1：使用可序列化的数据结构</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>MessageData</span><span class=p>&gt;</span> <span class=n>messages</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>MessageData</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>string</span> <span class=n>tempAudioPath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>string</span> <span class=n>sizePrompt</span> <span class=p>=</span> <span class=s>&#34;只需要回答话语，不要有任何动作(比如*推眼镜*等等)。只需要回答150词以内即可。&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//void Start()</span>
</span></span><span class=line><span class=cl>    <span class=k>void</span> <span class=n>Start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tempAudioPath</span> <span class=p>=</span> <span class=n>Path</span><span class=p>.</span><span class=n>Combine</span><span class=p>(</span><span class=n>Application</span><span class=p>.</span><span class=n>persistentDataPath</span><span class=p>,</span> <span class=s>&#34;tts_output.wav&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 初始化角色设定</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>MessageData</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>role</span> <span class=p>=</span> <span class=s>&#34;system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=c1>//content = npcCharacter.personalityPrompt + sizePrompt</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=p>=</span> <span class=n>sizePrompt</span><span class=p>+</span><span class=n>BGInputField</span><span class=p>.</span><span class=n>text</span> <span class=p>+</span><span class=s>&#34;你的名字为：&#34;</span><span class=p>+</span> <span class=n>RoleName</span><span class=p>.</span><span class=n>text</span><span class=p>+</span><span class=s>&#34;。&#34;</span> <span class=p>+</span> <span class=n>PersonalityInputField</span><span class=p>.</span><span class=n>text</span> 
</span></span><span class=line><span class=cl>        <span class=p>})</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 绑定发送事件</span>
</span></span><span class=line><span class=cl>        <span class=n>sendButton</span><span class=p>.</span><span class=n>onClick</span><span class=p>.</span><span class=n>AddListener</span><span class=p>(</span><span class=n>OnSendMessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>userInputField</span><span class=p>.</span><span class=n>onEndEdit</span><span class=p>.</span><span class=n>AddListener</span><span class=p>((</span><span class=n>text</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>Input</span><span class=p>.</span><span class=n>GetKeyDown</span><span class=p>(</span><span class=n>KeyCode</span><span class=p>.</span><span class=n>Return</span><span class=p>))</span> <span class=n>OnSendMessage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 为设定按钮添加监听</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加UI变更监听</span>
</span></span><span class=line><span class=cl>        <span class=n>BGInputField</span><span class=p>.</span><span class=n>onValueChanged</span><span class=p>.</span><span class=n>AddListener</span><span class=p>(</span><span class=n>_</span> <span class=p>=&gt;</span> <span class=n>InitializeSystemMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>RoleName</span><span class=p>.</span><span class=n>onValueChanged</span><span class=p>.</span><span class=n>AddListener</span><span class=p>(</span><span class=n>_</span> <span class=p>=&gt;</span> <span class=n>InitializeSystemMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>PersonalityInputField</span><span class=p>.</span><span class=n>onValueChanged</span><span class=p>.</span><span class=n>AddListener</span><span class=p>(</span><span class=n>_</span> <span class=p>=&gt;</span> <span class=n>InitializeSystemMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 按钮绑定更新系统消息</span>
</span></span><span class=line><span class=cl>        <span class=n>Button1</span><span class=p>.</span><span class=n>onClick</span><span class=p>.</span><span class=n>AddListener</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=n>InitializeSystemMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Button2</span><span class=p>.</span><span class=n>onClick</span><span class=p>.</span><span class=n>AddListener</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=n>InitializeSystemMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Button3</span><span class=p>.</span><span class=n>onClick</span><span class=p>.</span><span class=n>AddListener</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=n>InitializeSystemMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>void</span> <span class=n>InitializeSystemMessage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 动态获取UI输入值</span>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>dynamicPrompt</span> <span class=p>=</span> <span class=s>$&#34;{BGInputField.text}{RoleName.text}{PersonalityInputField.text}{sizePrompt}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 清除旧系统消息</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=p>.</span><span class=n>RemoveAll</span><span class=p>(</span><span class=n>m</span> <span class=p>=&gt;</span> <span class=n>m</span><span class=p>.</span><span class=n>role</span> <span class=p>==</span> <span class=s>&#34;system&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加新系统消息</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>MessageData</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>role</span> <span class=p>=</span> <span class=s>&#34;system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>dynamicPrompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>?</span> <span class=n>npcCharacter</span><span class=p>.</span><span class=n>personalityPrompt</span> <span class=p>+</span> <span class=n>sizePrompt</span> <span class=c1>// 默认值</span>
</span></span><span class=line><span class=cl>                <span class=p>:</span> <span class=n>dynamicPrompt</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=c1>// 发送消息</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>void</span> <span class=n>OnSendMessage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>InitializeSystemMessage</span><span class=p>();</span> <span class=c1>// 每次发送前更新系统消息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>userMessage</span> <span class=p>=</span> <span class=n>userInputField</span><span class=p>.</span><span class=n>text</span><span class=p>.</span><span class=n>Trim</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>userMessage</span><span class=p>))</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 显示玩家消息</span>
</span></span><span class=line><span class=cl>        <span class=n>AppendToChat</span><span class=p>(</span><span class=s>$&#34;玩家: {userMessage}&#34;</span><span class=p>,</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加到历史记录</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>MessageData</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>role</span> <span class=p>=</span> <span class=s>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=p>=</span> <span class=n>userMessage</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>userInputField</span><span class=p>.</span><span class=n>text</span> <span class=p>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>//调用api</span>
</span></span><span class=line><span class=cl>        <span class=n>StartCoroutine</span><span class=p>(</span><span class=n>CallDeepSeekAPI</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>void</span> <span class=n>OnSendMessage</span><span class=p>(</span><span class=kt>string</span> <span class=n>audioMess</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>userMessage</span> <span class=p>=</span> <span class=n>audioMess</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>userMessage</span><span class=p>))</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 显示玩家消息</span>
</span></span><span class=line><span class=cl>        <span class=n>AppendToChat</span><span class=p>(</span><span class=s>$&#34;玩家: {userMessage}&#34;</span><span class=p>,</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加到历史记录</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>MessageData</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>role</span> <span class=p>=</span> <span class=s>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=p>=</span> <span class=n>userMessage</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>userInputField</span><span class=p>.</span><span class=n>text</span> <span class=p>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>//调用api</span>
</span></span><span class=line><span class=cl>        <span class=n>StartCoroutine</span><span class=p>(</span><span class=n>CallDeepSeekAPI</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//角色思考文本动画</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>IEnumerator</span> <span class=n>BlinkText</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>alpha</span> <span class=p>=</span> <span class=n>Mathf</span><span class=p>.</span><span class=n>PingPong</span><span class=p>(</span><span class=n>Time</span><span class=p>.</span><span class=n>time</span><span class=p>,</span> <span class=m>1f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>thinkingIndicator</span><span class=p>.</span><span class=n>color</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Color</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=n>alpha</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// API通信协程</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>IEnumerator</span> <span class=n>CallDeepSeekAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//启动闪烁动画</span>
</span></span><span class=line><span class=cl>        <span class=n>thinkingIndicator</span><span class=p>.</span><span class=n>gameObject</span><span class=p>.</span><span class=n>SetActive</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>thinkingIndicator</span><span class=p>.</span><span class=n>text</span> <span class=p>=</span> <span class=n>RoleName</span><span class=p>.</span><span class=n>text</span><span class=p>+</span><span class=s>&#34;思考中……&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>SetAnimator</span><span class=p>(</span><span class=s>&#34;state&#34;</span><span class=p>,</span> <span class=m>1</span><span class=p>);</span> <span class=c1>// 设置动画状态为1</span>
</span></span><span class=line><span class=cl>        <span class=n>StartCoroutine</span><span class=p>(</span><span class=n>BlinkText</span><span class=p>());</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 构建符合API规范的结构体</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>requestBody</span> <span class=p>=</span> <span class=k>new</span> <span class=n>RequestBody</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span> <span class=p>=</span> <span class=n>modelName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span> <span class=p>=</span> <span class=n>messages</span><span class=p>.</span><span class=n>ToArray</span><span class=p>(),</span> <span class=c1>// 转换为数组</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span> <span class=p>=</span> <span class=n>temperature</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span> <span class=p>=</span> <span class=n>maxTokens</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>stream</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>jsonData</span> <span class=p>=</span> <span class=n>JsonUtility</span><span class=p>.</span><span class=n>ToJson</span><span class=p>(</span><span class=n>requestBody</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=p>[]</span> <span class=n>bodyRaw</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>Text</span><span class=p>.</span><span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>jsonData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>using</span> <span class=p>(</span><span class=n>UnityWebRequest</span> <span class=n>request</span> <span class=p>=</span> <span class=k>new</span> <span class=n>UnityWebRequest</span><span class=p>(</span><span class=n>apiUrl</span><span class=p>,</span> <span class=s>&#34;POST&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=p>.</span><span class=n>uploadHandler</span> <span class=p>=</span> <span class=k>new</span> <span class=n>UploadHandlerRaw</span><span class=p>(</span><span class=n>bodyRaw</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=p>.</span><span class=n>downloadHandler</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DownloadHandlerBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=p>.</span><span class=n>SetRequestHeader</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=p>.</span><span class=n>SetRequestHeader</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>,</span> <span class=s>$&#34;Bearer {apiKey}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=p>.</span><span class=n>SetRequestHeader</span><span class=p>(</span><span class=s>&#34;Accept-Language&#34;</span><span class=p>,</span> <span class=s>&#34;en-US&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=k>return</span> <span class=n>request</span><span class=p>.</span><span class=n>SendWebRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 3. 隐藏指示器</span>
</span></span><span class=line><span class=cl>            <span class=n>thinkingIndicator</span><span class=p>.</span><span class=n>gameObject</span><span class=p>.</span><span class=n>SetActive</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>StopCoroutine</span><span class=p>(</span><span class=n>BlinkText</span><span class=p>());</span> <span class=c1>// 可选：停止动画</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 修复3：添加详细错误处理</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>result</span> <span class=p>!=</span> <span class=n>UnityWebRequest</span><span class=p>.</span><span class=n>Result</span><span class=p>.</span><span class=n>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Debug</span><span class=p>.</span><span class=n>LogError</span><span class=p>(</span><span class=s>$&#34;API错误: {request.error}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>Debug</span><span class=p>.</span><span class=n>LogError</span><span class=p>(</span><span class=s>$&#34;状态码: {request.responseCode}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>Debug</span><span class=p>.</span><span class=n>LogError</span><span class=p>(</span><span class=s>$&#34;响应内容: {request.downloadHandler.text}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// 尝试解析错误详情</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>errorResponse</span> <span class=p>=</span> <span class=n>JsonUtility</span><span class=p>.</span><span class=n>FromJson</span><span class=p>&lt;</span><span class=n>ErrorResponse</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>                        <span class=n>request</span><span class=p>.</span><span class=n>downloadHandler</span><span class=p>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>                    <span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Debug</span><span class=p>.</span><span class=n>LogError</span><span class=p>(</span><span class=s>$&#34;错误类型: {errorResponse.error.type}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Debug</span><span class=p>.</span><span class=n>LogError</span><span class=p>(</span><span class=s>$&#34;错误信息: {errorResponse.error.message}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>catch</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Debug</span><span class=p>.</span><span class=n>LogError</span><span class=p>(</span><span class=s>&#34;无法解析错误响应&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>AppendToChat</span><span class=p>(</span><span class=s>&#34;系统: 对话服务暂时不可用&#34;</span><span class=p>,</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>yield</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 解析响应</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>response</span> <span class=p>=</span> <span class=n>JsonUtility</span><span class=p>.</span><span class=n>FromJson</span><span class=p>&lt;</span><span class=n>DeepSeekResponse</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>                <span class=n>request</span><span class=p>.</span><span class=n>downloadHandler</span><span class=p>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>//string botMessage = response.choices[0].message.content;</span>
</span></span><span class=line><span class=cl>            <span class=n>botMessage</span> <span class=p>=</span> <span class=n>response</span><span class=p>.</span><span class=n>choices</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=n>message</span><span class=p>.</span><span class=n>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 显示并存储AI回复</span>
</span></span><span class=line><span class=cl>            <span class=n>AppendToChat</span><span class=p>(</span><span class=s>$&#34;{RoleName.text}: {botMessage}&#34;</span><span class=p>,</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>MessageData</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>role</span> <span class=p>=</span> <span class=s>&#34;assistant&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span> <span class=p>=</span> <span class=n>botMessage</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=n>SetAnimator</span><span class=p>(</span><span class=s>&#34;state&#34;</span><span class=p>,</span> <span class=m>2</span><span class=p>);</span> <span class=c1>// 设置动画状态为2</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用TTS生成语音</span>
</span></span><span class=line><span class=cl>            <span class=c1>//StartCoroutine(CallTTSService(botMessage));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 更新对话显示</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>void</span> <span class=n>AppendToChat</span><span class=p>(</span><span class=kt>string</span> <span class=n>text</span><span class=p>,</span><span class=kt>bool</span> <span class=n>isBot</span> <span class=p>=</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置颜色</span>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>colorTag</span> <span class=p>=</span> <span class=n>isBot</span> <span class=p>?</span> <span class=s>&#34;&lt;color=#47A699&gt;&#34;</span> <span class=p>:</span> <span class=s>&#34;&lt;color=#FFFFFF&gt;&#34;</span><span class=p>;</span> <span class=c1>// 深蓝色为 #0000FF，白色为 #FFFFFF</span>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>closeTag</span> <span class=p>=</span> <span class=s>&#34;&lt;/color&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加颜色标签</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=p>=</span> <span class=s>$&#34;{colorTag}{text}{closeTag}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>chatOutputText</span><span class=p>.</span><span class=n>text</span> <span class=p>+=</span> <span class=s>$&#34;\n{text}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Canvas</span><span class=p>.</span><span class=n>ForceUpdateCanvases</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>chatOutputText</span><span class=p>.</span><span class=n>GetComponentInParent</span><span class=p>&lt;</span><span class=n>ScrollRect</span><span class=p>&gt;().</span><span class=n>verticalNormalizedPosition</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>//SetAnimator(&#34;state&#34;, 0); // 设置动画状态为0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置动画参数</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>void</span> <span class=n>SetAnimator</span><span class=p>(</span><span class=kt>string</span> <span class=n>_para</span><span class=p>,</span> <span class=kt>int</span> <span class=n>_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>m_Animator</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span> <span class=c1>// 如果动画控制器为空</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span> <span class=c1>// 直接返回</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>m_Animator</span><span class=p>.</span><span class=n>SetInteger</span><span class=p>(</span><span class=n>_para</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span> <span class=c1>// 设置动画控制器的整数参数</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 修复4：定义符合API规范的数据结构</span>
</span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>RequestBody</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>MessageData</span><span class=p>[]</span> <span class=n>messages</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>float</span> <span class=n>temperature</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>int</span> <span class=n>max_tokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>bool</span> <span class=n>stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>MessageData</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>role</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>DeepSeekResponse</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Choice</span><span class=p>[]</span> <span class=n>choices</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>Choice</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>Message</span> <span class=n>message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>Message</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>role</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 新增：错误响应结构</span>
</span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>ErrorResponse</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>ErrorInfo</span> <span class=n>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [System.Serializable]</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>ErrorInfo</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>string</span> <span class=n>param</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>新建空物体gameobj，把该脚本挂在上面。</p><p><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220204358524.png width=1322 height=313 srcset="/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220204358524_hu_403fbf0514501f69.png 480w, /p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220204358524_hu_4d5d18b120486336.png 1024w" loading=lazy alt=inspector class=gallery-image data-flex-grow=422 data-flex-basis=1013px></p><h2 id=2-用户界面>2 用户界面</h2><p>Unity交互层采用UGUI组件构建用户界面，界面设计遵循易用性原则，采用清晰的布局结构与视觉层次，确保用户能够直观理解各功能模块的作用与操作方式。交互层包含对话框界面与角色设定面板。对话框界面主要由以下组件构成：</p><ol><li><p>对话输入框：使用InputField组件，支持文本输入与语音输入两种方式，用户可直接输入文本或通过语音识别填充文本。</p></li><li><p>对话显示区域：使用TextMesh Pro组件，显示用户输入与AI回复的内容，通过不同颜色区分双方消息，并支持富文本格式显示。</p></li><li><p>滚动视图：使用ScrollRect组件包裹对话显示区域，实现对话历史的自动滚动，确保用户始终看到最新消息。</p></li><li><p>发送按钮：使用Button组件，点击后触发对话发送逻辑，将用户输入传递给智能对话模块。</p></li><li><p>语音输入按钮：使用Button组件，点击后开启语音录制功能，调用讯飞语音识别服务。</p></li><li><p>背景设置输入框：使用InputField组件，用户可输入对话场景配置描述，如"回答字数限制在100字以内"等。</p></li><li><p>确认按钮：使用Button组件，点击后将用户输入的角色设定信息注入智能对话模块。</p></li></ol><p><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220210225212.png width=1609 height=808 srcset="/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220210225212_hu_9d151a7a31348fc6.png 480w, /p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220210225212_hu_f6f5f9a235018185.png 1024w" loading=lazy class=gallery-image data-flex-grow=199 data-flex-basis=477px></p><blockquote><p>用了M Studio的插件，给不同组件上色方便归纳和查看。</p></blockquote><h2 id=3-脚本信息引用>3 脚本信息引用</h2><p>如图，脚本DeepSeekDialogueManager中开放出来的公共变量可以填上，跨物体引用组件。这里主要：</p><ul><li>填上api key / url</li><li>UI引用写入<ul><li>输入框</li><li>输出框</li><li>发送键</li><li>思考指示器</li><li>……</li></ul></li></ul><p><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220210500245.png width=721 height=1084 srcset="/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220210500245_hu_eda9a7984948229f.png 480w, /p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220210500245_hu_5d064b17a46efa7f.png 1024w" loading=lazy alt=image-20251220210500245 class=gallery-image data-flex-grow=66 data-flex-basis=159px></p><h2 id=4-初步测试对话功能>4 初步测试对话功能</h2><p><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220211442713.png width=989 height=552 srcset="/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220211442713_hu_91a3ba8a17efd947.png 480w, /p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%89/image-20251220211442713_hu_6afbfd9920933643.png 1024w" loading=lazy class=gallery-image data-flex-grow=179 data-flex-basis=430px></p><p>可以正常对话。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/note/>Note</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%BA%94/><div class=article-image><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%BA%94/cover1.097562be4e510d390980afa13e8f2642_hu_290b482c007123cc.png width=250 height=150 loading=lazy alt="Featured image of post 毕业设计 | 水墨风格化场景渲染（其五）" data-hash="md5-CXVivk5RDTkJgK+hPo8mQg=="></div><div class=article-details><h2 class=article-title>毕业设计 | 水墨风格化场景渲染（其五）</h2></div></a></article><article class=has-image><a href=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E5%9B%9B/><div class=article-image><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E5%9B%9B/cover1.097562be4e510d390980afa13e8f2642_hu_290b482c007123cc.png width=250 height=150 loading=lazy alt="Featured image of post 毕业设计 | 水墨风格化场景渲染（其四）" data-hash="md5-CXVivk5RDTkJgK+hPo8mQg=="></div><div class=article-details><h2 class=article-title>毕业设计 | 水墨风格化场景渲染（其四）</h2></div></a></article><article class=has-image><a href=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%80/><div class=article-image><img src=/p/%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1-%E6%B0%B4%E5%A2%A8%E9%A3%8E%E6%A0%BC%E5%8C%96%E5%9C%BA%E6%99%AF%E6%B8%B2%E6%9F%93%E5%85%B6%E4%B8%80/cover1.097562be4e510d390980afa13e8f2642_hu_290b482c007123cc.png width=250 height=150 loading=lazy alt="Featured image of post 毕业设计 | 水墨风格化场景渲染（其一）" data-hash="md5-CXVivk5RDTkJgK+hPo8mQg=="></div><div class=article-details><h2 class=article-title>毕业设计 | 水墨风格化场景渲染（其一）</h2></div></a></article><article class=has-image><a href=/p/unity-mcp-%E5%85%A8%E6%B5%81%E7%A8%8B/><div class=article-image><img src=/p/unity-mcp-%E5%85%A8%E6%B5%81%E7%A8%8B/cover1.f0ee1d8d7de22d60daf4501adfe94826_hu_84c42c197d6af0f3.png width=250 height=150 loading=lazy alt="Featured image of post Unity MCP 全流程" data-hash="md5-8O4djX3iLWDa9FAa3+lIJg=="></div><div class=article-details><h2 class=article-title>Unity MCP 全流程</h2></div></a></article><article class=has-image><a href=/p/unity%E5%8A%A8%E7%94%BB%E5%88%A0%E5%B8%A7%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7/><div class=article-image><img src=/p/unity%E5%8A%A8%E7%94%BB%E5%88%A0%E5%B8%A7%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7/cover1.f0ee1d8d7de22d60daf4501adfe94826_hu_84c42c197d6af0f3.png width=250 height=150 loading=lazy alt="Featured image of post Unity动画删帧优化工具" data-hash="md5-8O4djX3iLWDa9FAa3+lIJg=="></div><div class=article-details><h2 class=article-title>Unity动画删帧优化工具</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 Selaphina</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.34.2>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>